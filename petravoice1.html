// api/summarize.js
import { Configuration, OpenAIApi } from 'openai';

const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
});

const openai = new OpenAIApi(configuration);

// Simple in-memory rate limiter
const rateLimitMap = new Map();

export default async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).end(); // Method Not Allowed
  }

  const { userInput, summaryType } = req.body;

  if (!userInput) {
    return res.status(400).json({ error: 'No input text provided.' });
  }

  const ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;

  // Rate limiting logic
  const now = Date.now();
  const windowSize = 60 * 60 * 1000; // 1 hour
  const maxRequests = 10; // Max requests per window

  if (!rateLimitMap.has(ip)) {
    rateLimitMap.set(ip, { count: 1, startTime: now });
  } else {
    const userData = rateLimitMap.get(ip);
    if (now - userData.startTime > windowSize) {
      // Reset rate limit window
      rateLimitMap.set(ip, { count: 1, startTime: now });
    } else {
      if (userData.count >= maxRequests) {
        return res.status(429).json({ error: 'Rate limit exceeded. Please try again later.' });
      }
      userData.count += 1;
    }
  }

  const prompt = `
    Summarize the following text.
    - Format: ${summaryType}.
    - Keep the essential information.

    Text:
    ${userInput}
  `;

  try {
    const completion = await openai.createCompletion({
      model: 'gpt-4',
      prompt: prompt,
      max_tokens: 500,
      temperature: 0.5,
    });

    const summary = completion.data.choices[0].text.trim();
    res.status(200).json({ summary });
  } catch (error) {
    console.error('Error in Summarize API:', error);
    res.status(500).json({ error: 'Failed to generate summary.' });
  }
};
